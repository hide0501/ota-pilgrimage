<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ログイン | Ota Pilgrimage</title>
  <style>
    :root{--primary:#1D4ED8;--text:#0F172A;--bg:#F8FAFC;--muted:#64748B;}
    *{box-sizing:border-box} body{margin:0;font-family:Inter, Noto Sans JP, system-ui, sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:560px;margin:40px auto;padding:0 16px}
    .card{background:#fff;border-radius:16px;box-shadow:0 6px 18px rgba(2,6,23,.06);padding:20px}
    h1{margin:0 0 12px;font-size:24px} p{margin:.5rem 0}
    label{display:block;font-size:14px;color:var(--muted);margin:10px 0 6px}
    input{width:100%;padding:12px;border:1px solid #E5E7EB;border-radius:12px;font-size:16px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border:none;border-radius:12px;background:var(--primary);color:#fff;font-weight:600;cursor:pointer}
    .btn.secondary{background:#EA4335}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#111827;color:#fff;padding:10px 16px;border-radius:999px;display:none}
    .muted{color:var(--muted);font-size:12px}
    .topnav{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    a{color:var(--primary);text-decoration:none}
  </style>
  <!-- Firebase CDN (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-check-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="topnav">
      <a href="/">← ホーム</a>
      <button id="signOutBtn" class="btn" style="display:none">ログアウト</button>
    </div>
    <div class="card">
      <h1>ログイン / Sign in</h1>
      <p class="muted">メールリンク（パスワード不要）またはGoogleでログインできます。</p>
      <label for="email">メールアドレス</label>
      <input id="email" type="email" placeholder="you@example.com" autocomplete="email"/>
      <div class="row" style="margin-top:12px">
        <button id="sendLinkBtn" class="btn">ログインリンクを送信</button>
        <button id="googleBtn" class="btn secondary">Googleで続行</button>
      </div>
      <p class="muted">リンクを送信後、メールのリンクをタップ（またはこの端末で開いてください）。</p>
      <div id="status" class="muted"></div>
    </div>
    <div id="toast" class="toast"></div>
  </div>

<script>
const $ = (id)=>document.getElementById(id);
const toast = (msg)=>{ const el=$('toast'); el.textContent=msg; el.style.display='block'; setTimeout(()=>el.style.display='none',2500); };
const setStatus = (msg)=>{ $('status').textContent = msg || ''; };

async function loadConfig(){
  const res = await fetch('/api/config', {cache:'no-store'});
  if(!res.ok){ throw new Error('設定の取得に失敗しました'); }
  return await res.json();
}

async function init(){
  try{
    const cfg = await loadConfig();
    firebase.initializeApp({
      apiKey: cfg.FIREBASE_API_KEY,
      authDomain: cfg.FIREBASE_AUTH_DOMAIN,
      projectId: cfg.FIREBASE_PROJECT_ID,
      storageBucket: cfg.FIREBASE_STORAGE_BUCKET,
      appId: cfg.FIREBASE_APP_ID,
      measurementId: cfg.FIREBASE_MEASUREMENT_ID || undefined
    });
    if (cfg.APP_CHECK_SITE_KEY){
      self.FIREBASE_APPCHECK_DEBUG_TOKEN = cfg.APPCHECK_DEBUG === 'true' ? true : undefined;
      firebase.appCheck().activate(cfg.APP_CHECK_SITE_KEY, true);
    }
  }catch(e){
    console.error(e); toast('初期化に失敗しました'); throw e;
  }
}

async function main(){
  await init();
  const auth = firebase.auth();

  if (auth.isSignInWithEmailLink(location.href)) {
    let email = window.localStorage.getItem('emailForSignIn') || window.prompt('登録メールを入力してください / Enter your email');
    try{
      await auth.signInWithEmailLink(email, location.href);
      window.localStorage.removeItem('emailForSignIn');
      toast('ログインしました');
    }catch(e){
      console.error(e); toast('メールリンクが無効/期限切れです');
    }
  }

  $('sendLinkBtn').onclick = async ()=>{
    const email = $('email').value.trim();
    if(!email) return toast('メールを入力してください');
    try{
      await auth.sendSignInLinkToEmail(email, { url: location.origin + '/auth.html', handleCodeInApp: true });
      window.localStorage.setItem('emailForSignIn', email);
      toast('ログインリンクを送信しました');
      setStatus('メールを確認してください。開けない場合は同じ端末でリンクをタップ。');
    }catch(e){
      console.error(e);
      const code = e.code || '';
      if(code.includes('auth/too-many-requests')) toast('リクエストが多すぎます。しばらくして再試行してください。');
      else if(code.includes('auth/invalid-email')) toast('メール形式が正しくありません');
      else toast('送信に失敗しました');
    }
  };

  $('googleBtn').onclick = async ()=>{
    try{
      await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
      toast('ログインしました');
      location.href = '/';
    }catch(e){
      console.error(e); toast('Googleログインに失敗しました');
    }
  };

  $('signOutBtn').onclick = async ()=>{ await auth.signOut(); toast('ログアウトしました'); };

  auth.onAuthStateChanged(user=>{
    $('signOutBtn').style.display = user ? 'inline-flex' : 'none';
    setStatus(user ? `ログイン中：${user.email}` : '未ログイン');
  });
}
main();
</script>
</body>
</html>
